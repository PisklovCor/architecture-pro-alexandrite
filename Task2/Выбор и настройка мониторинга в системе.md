# Выбор и настройка мониторинга в системе "Александрит"

## Мотивация

### Бизнес-обоснование внедрения мониторинга

Внедрение комплексного мониторинга критически необходимо для системы "Александрит" по следующим причинам:

**1. Предотвращение потери клиентов**
- Система обрабатывает заказы на драгоценности стоимостью до 1 млн рублей
- Медленная работа или сбои приводят к потере клиентов и репутации
- Мониторинг позволит выявлять проблемы до их влияния на пользователей

**2. Обеспечение непрерывности бизнес-процессов**
- MES система критична для производства - простои блокируют весь процесс
- CRM система используется продавцами для работы с клиентами
- Онлайн-магазин - основной канал продаж

**3. Оптимизация ресурсов и затрат**
- Выявление узких мест в производительности
- Планирование масштабирования на основе реальных данных
- Снижение времени простоя и связанных с ним потерь

**4. Соответствие SLA и качеству сервиса**
- Гарантированное время отклика для критических операций
- Отслеживание доступности системы 24/7
- Быстрое восстановление после инцидентов

**5. Поддержка принятия решений**
- Данные для планирования развития архитектуры
- Обоснование инвестиций в инфраструктуру
- Анализ эффективности оптимизаций

## Выбор подхода к мониторингу

### Гибридный подход с использованием разных методологий

Для системы "Александрит" выбран гибридный подход, сочетающий несколько методологий:

**1. Четыре золотых сигнала (для API сервисов)**
- **Latency** - время отклика API (критично для пользовательского опыта)
- **Traffic** - количество запросов (плановая нагрузка и пики)
- **Errors** - частота ошибок (качество сервиса)
- **Saturation** - загрузка ресурсов (потенциальные узкие места)

**2. USE метод (для инфраструктуры)**
- **Utilization** - использование CPU, памяти, диска
- **Saturation** - очереди, задержки, перегрузка
- **Errors** - аппаратные и системные ошибки

**3. RED метод (для микросервисов)**
- **Rate** - количество запросов в секунду
- **Errors** - частота ошибок
- **Duration** - время выполнения запросов

### Обоснование выбора

**Четыре золотых сигнала** идеально подходят для API-сервисов (магазин, CRM, MES), так как:
- Фокусируются на пользовательском опыте
- Покрывают все аспекты производительности
- Легко интерпретируются бизнесом

**USE метод** необходим для инфраструктурных компонентов (базы данных, RabbitMQ, S3), так как:
- Позволяет выявить проблемы на уровне ресурсов
- Помогает планировать масштабирование
- Предотвращает отказы из-за нехватки ресурсов

**RED метод** дополняет мониторинг для детального анализа микросервисов.

## Метрики и их назначение

### 1. Метрики производительности API (Latency)

**Response time (latency) для shop API, CRM API, MES API**
- **Назначение**: Контроль качества пользовательского опыта
- **Ярлыки**: `api="shop|crm|mes"`, `endpoint="/orders|/products|/dashboard"`
- **Пороговые значения**: 
  - shop API: < 200ms (95-й перцентиль)
  - CRM API: < 500ms (95-й перцентиль) 
  - MES API: < 1000ms (95-й перцентиль)

### 2. Метрики нагрузки (Traffic)

**Number of requests (RPS) для всех API**
- **Назначение**: Планирование нагрузки, выявление пиков, масштабирование
- **Ярлыки**: `api="shop|crm|mes"`, `method="GET|POST|PUT|DELETE"`
- **Дополнительные метрики**: RPS per user для анализа поведения пользователей

**Number of simultaneous sessions для всех API**
- **Назначение**: Контроль активных пользователей, планирование ресурсов
- **Ярлыки**: `api="shop|crm|mes"`, `user_type="customer|seller|operator"`

### 3. Метрики ошибок (Errors)

**HTTP 200/500 для всех API**
- **Назначение**: Контроль качества сервиса, выявление проблем
- **Ярлыки**: `api="shop|crm|mes"`, `status_code="200|500"`, `endpoint="/orders|/products"`
- **Дополнительные метрики**: Error rate (500/total requests)

### 4. Метрики насыщения (Saturation)

**CPU % для всех API**
- **Назначение**: Выявление узких мест производительности
- **Ярлыки**: `service="shop-api|crm-api|mes-api"`, `instance="primary|replica"`
- **Пороговые значения**: Warning > 70%, Critical > 85%

**Memory Utilisation для всех API и БД**
- **Назначение**: Контроль потребления памяти, предотвращение OOM
- **Ярлыки**: `service="shop-api|crm-api|mes-api|shop-db|mes-db"`
- **Пороговые значения**: Warning > 80%, Critical > 90%

### 5. Метрики инфраструктуры

**Number of connections для БД**
- **Назначение**: Контроль подключений, планирование пулов соединений
- **Ярлыки**: `database="shop|mes"`, `connection_type="active|idle|waiting"`

**Size of databases и S3 storage**
- **Назначение**: Планирование места, архивирование данных
- **Ярлыки**: `database="shop|mes"`, `storage="s3"`

### 6. Метрики интеграции

**RabbitMQ метрики**
- **Number of dead-letter-exchange letters**: Контроль проблем интеграции
- **Number of message in flight**: Контроль загрузки очередей
- **Ярлыки**: `queue="order-sync|price-calculation"`, `status="active|failed"`

### 7. Метрики сети

**Kb transferred (received/sent) для всех API**
- **Назначение**: Анализ трафика, выявление аномалий
- **Ярлыки**: `api="shop|crm|mes"`, `direction="inbound|outbound"`

## План действий

### Этап 1: Подготовка инфраструктуры (2-3 недели)

1. **Создание time-series базы данных**
   - Развертывание Prometheus в Yandex Cloud
   - Настройка retention policy (30 дней для метрик, 1 год для агрегированных)
   - Конфигурация кластера для высокой доступности

2. **Настройка системы визуализации**
   - Установка Grafana
   - Создание дашбордов для каждой команды (DevOps, Backend, Frontend)
   - Настройка ролевой модели доступа

3. **Внедрение системы алертинга**
   - Интеграция с Yandex Cloud Monitoring
   - Настройка уведомлений в Slack/Telegram
   - Создание эскалационных правил

### Этап 2: Инструментирование приложений (3-4 недели)

1. **Добавление метрик в Spring Boot приложения**
   - Интеграция Micrometer с Prometheus
   - Настройка custom metrics для бизнес-логики
   - Добавление health checks

2. **Инструментирование C# MES приложения**
   - Интеграция Prometheus.NET
   - Настройка метрик производительности
   - Добавление custom counters

3. **Мониторинг баз данных**
   - Настройка PostgreSQL exporters
   - Мониторинг connection pools
   - Отслеживание slow queries

### Этап 3: Настройка мониторинга инфраструктуры (2-3 недели)

1. **Мониторинг RabbitMQ**
   - Установка RabbitMQ Prometheus plugin
   - Настройка метрик очередей и exchanges
   - Мониторинг dead letter queues

2. **Мониторинг S3 и облачной инфраструктуры**
   - Интеграция с Yandex Cloud Monitoring
   - Настройка метрик использования ресурсов
   - Мониторинг costs и billing

3. **Настройка логирования**
   - Централизованный сбор логов через ELK Stack
   - Корреляция логов с метриками
   - Настройка log-based alerting

### Этап 4: Создание дашбордов и алертов (2-3 недели)

1. **Бизнес-дашборды**
   - Общий дашборд для руководства
   - Дашборд по заказам и конверсии
   - Дашборд по производительности системы

2. **Технические дашборды**
   - Дашборд для DevOps команды
   - Дашборд для разработчиков
   - Дашборд по инфраструктуре

3. **Настройка алертов**
   - Критические алерты (SLA нарушения)
   - Предупреждающие алерты (деградация производительности)
   - Информационные алерты (тренды и аномалии)

### Этап 5: Обучение и документирование (1-2 недели)

1. **Обучение команд**
   - Тренинг по работе с Grafana
   - Обучение реагированию на алерты
   - Создание runbooks для типовых инцидентов

2. **Документирование**
   - Создание руководства по мониторингу
   - Документирование процедур реагирования
   - Настройка knowledge base

## Показатели насыщенности и алертинг

### Критические пороговые значения

**1. API Response Time**
- **Порог**: 95-й перцентиль > 2 секунды
- **Действие**: 
  - Немедленный алерт в Slack #incidents
  - Автоматическое создание тикета в Jira
  - Уведомление ответственного разработчика
  - При превышении 5 секунд - эскалация к тимлиду

**2. Error Rate**
- **Порог**: > 5% ошибок за 5 минут
- **Действие**:
  - Критический алерт с автоматическим вызовом
  - Создание инцидента в системе управления
  - Автоматический rollback при превышении 10%

**3. CPU Utilization**
- **Порог**: > 85% в течение 10 минут
- **Действие**:
  - Предупреждающий алерт
  - Автоматическое масштабирование (если настроено)
  - Уведомление DevOps команды

**4. Memory Utilization**
- **Порог**: > 90% в течение 5 минут
- **Действие**:
  - Критический алерт
  - Автоматический перезапуск сервиса
  - Немедленное уведомление команды

**5. Database Connections**
- **Порог**: > 80% от максимального пула
- **Действие**:
  - Предупреждающий алерт
  - Анализ slow queries
  - Планирование масштабирования БД

**6. RabbitMQ Dead Letters**
- **Порог**: > 10 сообщений в час
- **Действие**:
  - Алерт в Slack #integration-issues
  - Автоматический анализ причин
  - Уведомление команды интеграции

### Эскалационные правила

**Уровень 1 (0-15 минут)**: Автоматические действия, уведомление ответственного
**Уровень 2 (15-30 минут)**: Эскалация к тимлиду, привлечение дополнительных ресурсов
**Уровень 3 (30+ минут)**: Эскалация к архитектору, план восстановления, постмортем

### Автоматические действия

1. **Auto-scaling** для API сервисов при высокой нагрузке
2. **Circuit breaker** для внешних интеграций
3. **Graceful degradation** при нехватке ресурсов
4. **Automatic rollback** при критических ошибках
5. **Resource provisioning** при превышении лимитов

Этот план мониторинга обеспечит полную наблюдаемость системы "Александрит" и позволит предотвращать проблемы до их влияния на бизнес.
