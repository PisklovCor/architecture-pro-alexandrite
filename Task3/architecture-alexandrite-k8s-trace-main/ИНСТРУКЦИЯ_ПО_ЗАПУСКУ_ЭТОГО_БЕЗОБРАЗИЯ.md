# Инструкция по запуску сервисов с трейсингом OpenTelemetry и Jaeger

## Описание проекта

Созданы два Spring Boot сервиса:
- **service-a** - основной сервис, который вызывает service-b
- **service-b** - вспомогательный сервис, обрабатывающий запросы

Оба сервиса настроены для отправки трейсов в Jaeger через OpenTelemetry.

## Структура проекта

```
services/
├── service-a/
│   ├── src/main/java/com/example/servicea/
│   │   ├── ServiceAApplication.java
│   │   ├── config/OpenTelemetryConfig.java
│   │   └── controller/ServiceAController.java
│   ├── src/main/resources/application.properties
│   ├── pom.xml
│   └── Dockerfile
└── service-b/
    ├── src/main/java/com/example/serviceb/
    │   ├── ServiceBApplication.java
    │   ├── config/OpenTelemetryConfig.java
    │   └── controller/ServiceBController.java
    ├── src/main/resources/application.properties
    ├── pom.xml
    └── Dockerfile
```

## Требования

- Minikube
- kubectl
- Docker
- Maven (для локальной разработки)

## Пошаговая инструкция запуска

### 1. Запуск Minikube

```bash

minikube start
```

```bash

minikube addons enable ingress
```

```bash 

# Лучше отдельное окно
minikube tunnel
```
### 2. Установка cert-manager

```bash

kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml
```

### 3. Развертывание Jaeger

```bash

# Создание namespace
kubectl create namespace observability

# Установка Jaeger Operator
kubectl create -f https://github.com/jaegertracing/jaeger-operator/releases/download/v1.51.0/jaeger-operator.yaml -n observability

# Развертывание Jaeger instance
kubectl apply -f k8s/jaeger-instance.yaml
```

### 4. Сборка Docker образов

```bash

# Сборка образа service-a
minikube image build -t service-a:latest services/service-a/

# Сборка образа service-b
minikube image build -t service-b:latest services/service-b/
```

### 5. Развертывание сервисов

```bash

kubectl apply -f k8s/services.yaml
```

### 6. Проверка статуса развертывания

```bash

# Проверка подов
kubectl get pods

# Проверка сервисов
kubectl get services

# Проверка логов service-a
kubectl logs -l app=service-a

# Проверка логов service-b
kubectl logs -l app=service-b
```

## Тестирование

### 1. Доступ к Jaeger UI

```bash

kubectl port-forward svc/simplest-query 16686:16686
```

Откройте в браузере: http://localhost:16686

### 2. Выполнение тестового запроса

**Рекомендуемый способ: Через port-forward (самый простой)**
```bash

# Проброс порта service-a
kubectl port-forward svc/service-a 8080:8080

# В другом терминале выполните запрос
curl http://localhost:8080
```

**Альтернативные способы:**

**Способ 1: Через wget (после пересборки образа)**
```bash

# Вызов service-a, который автоматически вызовет service-b
kubectl exec -it $(kubectl get pods -l app=service-a -o jsonpath='{.items[0].metadata.name}') -- wget -qO- http://service-a:8080
```

**Способ 2: Через curl в поде (после пересборки образа)**
```bash

# Выполнение запроса
kubectl exec -it $(kubectl get pods -l app=service-a -o jsonpath='{.items[0].metadata.name}') -- curl http://service-a:8080
```

**Способ 3: Через временный под с curl**
```bash

# Создание временного пода с curl
kubectl run test-pod --image=curlimages/curl --rm -it -- sh

# Внутри пода выполните:
curl http://service-a:8080
```

Ожидаемый ответ:
```
Service A processed request. Service B response: Service B processed request successfully
```

### 3. Просмотр трейсов в Jaeger

1. Откройте Jaeger UI по адресу http://localhost:16686
2. В выпадающем списке "Service" выберите "service-a"
3. Нажмите "Find Traces"
4. Вы должны увидеть трейс с двумя спанами:
   - `service-a-process` - основной спана service-a
   - `call-service-b` - спана вызова service-b
   - `service-b-process` - спана обработки в service-b

## Архитектура трейсинга

### Service A
- Создает корневой спана `service-a-process`
- Вызывает service-b через HTTP
- Создает дочерний спана `call-service-b` для HTTP вызова
- Обрабатывает ответ от service-b

### Service B
- Создает спана `service-b-process` для обработки запроса
- Имитирует обработку с задержкой 100ms
- Возвращает успешный ответ

### OpenTelemetry конфигурация
- Использует Jaeger gRPC exporter
- Отправляет трейсы на `http://simplest-collector:14250`
- Настроены атрибуты сервисов для корректной группировки

## Возможные проблемы и решения

### 1. Сервисы не запускаются
```bash

# Проверьте логи
kubectl logs -l app=service-a
kubectl logs -l app=service-b

# Проверьте статус подов
kubectl describe pod <pod-name>
```

### 2. Трейсы не отображаются в Jaeger
- Убедитесь, что Jaeger collector запущен: `kubectl get pods -n observability`
- Проверьте, что сервисы могут достучаться до collector
- Подождите 1-2 минуты после выполнения запроса

### 3. Service A не может вызвать Service B
- Проверьте, что оба сервиса запущены: `kubectl get pods`
- Проверьте DNS резолюцию: `kubectl exec -it <service-a-pod> -- nslookup service-b`

## Очистка

```bash

# Удаление сервисов
kubectl delete -f k8s/services.yaml

# Удаление Jaeger
kubectl delete -f k8s/jaeger-instance.yaml
kubectl delete -f https://github.com/jaegertracing/jaeger-operator/releases/download/v1.51.0/jaeger-operator.yaml -n observability
kubectl delete namespace observability

# Остановка Minikube
minikube stop
```
