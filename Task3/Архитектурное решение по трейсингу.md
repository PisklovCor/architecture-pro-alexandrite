# Архитектурное решение по трейсингу для системы "Александрит"

## Анализ системы и C4-диаграммы

### Критические точки для трейсинга

На основе анализа C4-диаграммы системы "Александрит" выявлены следующие критические точки, где заказы могут "сломаться" или зависнуть:

**1. Точки входа заказов:**
- Internet Shop → Shop API (создание заказа)
- Customer → Internet Shop (загрузка 3D модели)

**2. Точки обработки заказов:**
- Shop API → Shop DB (сохранение заказа)
- Shop API → 3D files storage (загрузка файлов)
- CRM API → Messages Queue (синхронизация с MES)
- Messages Queue → MES API (передача заказа в производство)

**3. Точки управления заказами:**
- MES API → MES DB (обновление статусов)
- MES API → 3D files storage (доступ к файлам)
- Operator → MES (работа с заказом)
- Seller → CRM (подтверждение заказа)

**4. Точки интеграции:**
- Все взаимодействия через Messages Queue (RabbitMQ)
- API-to-API вызовы между сервисами

### Данные для трейсинга

**Обязательные данные:**
- Order ID (уникальный идентификатор заказа)
- Trace ID (уникальный идентификатор трейса)
- Span ID (идентификатор операции)
- Parent Span ID (связь между операциями)
- Timestamp (время выполнения операции)
- Service Name (название сервиса)
- Operation Name (название операции)
- Status (success/error)
- Duration (время выполнения)

**Бизнес-контекст:**
- Customer ID
- Order Status
- 3D File ID
- Operator ID (если назначен)
- Seller ID (если обрабатывается)

**Технические данные:**
- HTTP Status Code
- Request/Response Size
- Database Query Time
- External API Call Duration
- Error Messages
- Stack Traces (при ошибках)

## Мотивация

### Бизнес-обоснование внедрения трейсинга

**1. Снижение потерь от зависших заказов**
- Заказы на драгоценности стоимостью до 1 млн рублей не должны теряться
- Трейсинг позволит быстро находить и восстанавливать "зависшие" заказы
- Ожидаемое снижение потерь: 15-20% от текущих потерь

**2. Улучшение клиентского опыта**
- Прозрачность процесса обработки заказа для клиента
- Возможность предоставить клиенту точную информацию о статусе
- Снижение количества обращений в поддержку на 30%

**3. Оптимизация производственных процессов**
- Выявление узких мест в обработке заказов
- Оптимизация времени производства
- Улучшение планирования ресурсов

**4. Соответствие SLA**
- Гарантированное время обработки заказа
- Отслеживание выполнения обязательств перед клиентами
- Автоматическое выявление нарушений SLA

### Технические и бизнес-метрики

**Технические метрики:**
1. **Время обработки заказа** - от создания до завершения (цель: < 7 дней)
2. **Процент успешно обработанных заказов** - без зависаний и ошибок (цель: > 95%)
3. **Время отклика API** - для всех критических операций (цель: < 500ms)
4. **Количество ошибок интеграции** - между сервисами (цель: < 1%)
5. **Время восстановления** - после обнаружения проблемы (цель: < 30 минут)

**Бизнес-метрики:**
1. **Конверсия заказов** - от создания до оплаты (ожидаемое улучшение: +10%)
2. **Время до первого ответа клиенту** - при обращении в поддержку (цель: < 2 часа)
3. **Количество эскалаций** - сложных случаев, требующих вмешательства (снижение на 40%)
4. **Удовлетворенность клиентов** - по опросам (цель: > 4.5/5)
5. **Операционная эффективность** - время обработки заказа оператором (улучшение на 25%)

## Предлагаемое решение

### Архитектура трейсинга

**Технологический стек:**
- **Jaeger** - распределенный трейсинг (основной инструмент)
- **OpenTelemetry** - стандартизированная библиотека для инструментирования
- **Elasticsearch** - хранение трейсов (интеграция с существующим ELK)
- **Kibana** - визуализация трейсов
- **Grafana** - дашборды и алерты (интеграция с существующим мониторингом)

**Компоненты системы трейсинга:**

1. **Jaeger Collector** - сбор трейсов от всех сервисов
2. **Jaeger Query** - API для поиска и анализа трейсов
3. **Jaeger UI** - веб-интерфейс для просмотра трейсов
4. **OpenTelemetry Agent** - агент для автоматического инструментирования
5. **Custom Tracing Library** - библиотека для бизнес-трейсинга

### Инструментирование сервисов

**1. Shop API (Spring Boot)**
```java
// Автоматическое инструментирование HTTP запросов
// Кастомные спанны для бизнес-операций
@NewSpan("create-order")
public Order createOrder(OrderRequest request) {
    // Создание заказа с трейсингом
}

@NewSpan("upload-3d-file")
public FileInfo uploadFile(MultipartFile file) {
    // Загрузка файла с трейсингом
}
```

**2. CRM API (Spring Boot)**
```java
@NewSpan("sync-order-to-mes")
public void syncOrderToMES(Order order) {
    // Синхронизация заказа с MES
}

@NewSpan("update-order-status")
public void updateOrderStatus(String orderId, OrderStatus status) {
    // Обновление статуса заказа
}
```

**3. MES API (C#)**
```csharp
// Инструментирование через OpenTelemetry .NET
[ActivitySource("MES.API")]
public class OrderService
{
    [Activity("assign-order-to-operator")]
    public async Task AssignOrderToOperator(string orderId, string operatorId)
    {
        // Назначение заказа оператору
    }
}
```

**4. Frontend приложения (Vue.js)**
```javascript
// Трейсинг пользовательских действий
import { trace } from '@opentelemetry/api';

const tracer = trace.getTracer('internet-shop');

function createOrder(orderData) {
    const span = tracer.startSpan('user-create-order');
    // Создание заказа с трейсингом
    span.end();
}
```

### Интеграция с существующей системой

**1. Интеграция с мониторингом**
- Корреляция трейсов с метриками Prometheus
- Алерты на основе трейсинга (медленные операции, ошибки)
- Дашборды в Grafana с трейсинг-данными

**2. Интеграция с логированием**
- Связь трейсов с логами через Trace ID
- Централизованный поиск по трейсам в ELK
- Автоматическое добавление Trace ID в логи

**3. Интеграция с бизнес-процессами**
- Уведомления о критических событиях в заказе
- Автоматическое создание тикетов при проблемах
- Интеграция с CRM для уведомления клиентов

### Схема архитектуры

[Ссылка на обновленную C4-диаграмму с компонентами трейсинга](Task3/jewerly_c4_model_with_tracing.drawio)

**Новые компоненты (выделены красным):**
- Jaeger Collector
- Jaeger Query & UI
- OpenTelemetry Agent
- Tracing Database (Elasticsearch)
- Tracing Integration Layer

**Новые связи (выделены красным):**
- Все сервисы → Jaeger Collector
- Jaeger Collector → Tracing Database
- Jaeger Query → Tracing Database
- Grafana → Jaeger Query (для дашбордов)
- ELK Stack → Jaeger Query (для корреляции)

## Компромиссы

### Ограничения и сложности

**1. Производительность**
- **Проблема**: Трейсинг добавляет накладные расходы на каждый запрос
- **Компромисс**: Использование sampling (1% для production, 100% для staging)
- **Решение**: Асинхронная отправка трейсов, буферизация

**2. Объем данных**
- **Проблема**: Трейсы генерируют большой объем данных
- **Компромисс**: Ограниченное время хранения (30 дней для детальных трейсов)
- **Решение**: Агрегация и архивирование старых данных

**3. Инструментирование legacy кода**
- **Проблема**: C# MES приложение может быть сложно инструментировать
- **Компромисс**: Частичное покрытие трейсингом
- **Решение**: Поэтапное внедрение, начиная с критических операций

**4. Сложность интеграции**
- **Проблема**: Необходимость изменения всех сервисов
- **Компромисс**: Длительный период внедрения
- **Решение**: Поэтапное внедрение по приоритету сервисов

**5. Стоимость инфраструктуры**
- **Проблема**: Дополнительные ресурсы для хранения и обработки трейсов
- **Компромисс**: Увеличение затрат на инфраструктуру на 15-20%
- **Решение**: Оптимизация хранения, использование облачных сервисов

### Случаи, когда трейсинг не принесет пользы

**1. Синхронные операции в рамках одного сервиса**
- Простые CRUD операции без внешних вызовов
- Внутренние вычисления без бизнес-логики

**2. Высокочастотные операции**
- Логирование каждого клика пользователя
- Периодические health checks

**3. Legacy системы без возможности изменения**
- Проприетарные системы без API
- Системы с ограниченными возможностями инструментирования

## Аспекты безопасности

### Внутренняя безопасность

**1. Аутентификация и авторизация**
- Интеграция с корпоративным LDAP/Active Directory
- Ролевая модель доступа:
  - **Support** - просмотр трейсов для решения проблем
  - **Developer** - доступ к трейсам своих сервисов
  - **DevOps** - полный доступ к системе трейсинга
  - **Manager** - доступ к агрегированным отчетам

**2. Шифрование данных**
- TLS 1.3 для всех соединений между компонентами
- Шифрование данных в покое (AES-256)
- Ротация ключей шифрования каждые 90 дней

**3. Аудит и логирование**
- Логирование всех действий пользователей в системе трейсинга
- Аудит доступа к чувствительным данным
- Интеграция с SIEM для мониторинга безопасности

### Защита чувствительных данных

**1. Маскирование данных**
- Автоматическое маскирование персональных данных в трейсах
- Маскирование номеров карт, email, телефонов
- Возможность настройки правил маскирования

**2. Контроль доступа к данным**
- Разделение трейсов по окружениям (dev/staging/prod)
- Ограничение доступа к production данным
- Временные токены доступа для внешних консультантов

**3. Соответствие требованиям**
- GDPR compliance для персональных данных
- Локальное хранение данных в России
- Возможность удаления данных по запросу

### Внешняя безопасность

**1. Сетевая безопасность**
- Firewall правила для доступа к Jaeger UI
- VPN доступ для удаленных сотрудников
- DDoS защита на уровне облачного провайдера

**2. API безопасность**
- Rate limiting для API трейсинга
- API ключи для внешних интеграций
- Валидация всех входящих данных

## Автоматический мониторинг и алертинг

### Мониторинг процесса прохождения заказа

**1. Автоматическое отслеживание жизненного цикла заказа**
- Создание заказа → Shop API
- Загрузка 3D файла → 3D Storage
- Синхронизация с MES → Messages Queue
- Назначение оператору → MES API
- Изготовление → Operator
- Завершение → MES API

**2. Детекция аномалий**
- Заказы, зависшие более 24 часов на одном этапе
- Ошибки интеграции между сервисами
- Превышение SLA по времени обработки
- Потеря сообщений в очереди

**3. Автоматические действия**
- Перезапуск зависших процессов
- Повторная отправка потерянных сообщений
- Уведомление ответственных лиц
- Создание инцидентов в системе управления

### Система алертинга

**1. Критические алерты (немедленное реагирование)**
- Заказ завис более 2 часов на критическом этапе
- Ошибка интеграции между Shop API и MES
- Потеря заказа в системе
- Превышение SLA на 50%

**2. Предупреждающие алерты (реагирование в течение часа)**
- Заказ обрабатывается дольше обычного
- Высокий процент ошибок в интеграции
- Медленная работа системы трейсинга
- Приближение к лимитам ресурсов

**3. Информационные алерты (мониторинг трендов)**
- Необычные паттерны в обработке заказов
- Изменения в производительности системы
- Статистика по типам ошибок
- Отчеты по использованию системы

### Интеграция с существующими системами

**1. Интеграция с мониторингом**
- Корреляция трейсов с метриками Prometheus
- Алерты в Grafana на основе трейсинга
- Дашборды с трейсинг-данными

**2. Интеграция с управлением инцидентами**
- Автоматическое создание тикетов при проблемах
- Обновление статуса тикетов на основе трейсов
- Закрытие тикетов при решении проблем

**3. Интеграция с уведомлениями**
- Slack/Telegram уведомления для команды
- Email уведомления для клиентов при задержках
- SMS уведомления для критических проблем

### Обновленная схема с мониторингом

[Ссылка на финальную C4-диаграмму с мониторингом и алертингом](Task3/jewerly_c4_model_with_monitoring.drawio)

**Новые компоненты (выделены зеленым):**
- Alert Manager
- Incident Management System
- Notification Service
- Anomaly Detection Engine
- SLA Monitoring Service

**Новые связи (выделены зеленым):**
- Jaeger → Alert Manager
- Alert Manager → Notification Service
- Alert Manager → Incident Management
- Grafana → Alert Manager
- Anomaly Detection → Alert Manager

Это решение обеспечит полную наблюдаемость системы "Александрит" и позволит предотвращать проблемы с заказами до их влияния на бизнес.
