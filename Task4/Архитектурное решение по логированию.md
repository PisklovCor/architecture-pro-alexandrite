# Архитектурное решение по логированию для системы "Александрит"

## Анализ системы и C4-диаграммы в контексте планирования логирования

### Критические точки для сбора логов

На основе анализа C4-диаграммы системы "Александрит" выявлены следующие критические точки, где необходимо собирать логи:

**1. Пользовательские интерфейсы:**
- Internet Shop (Vue, TypeScript, Threejs) - действия пользователей
- CRM (Vue, TypeScript) - действия продавцов
- MES (React, TypeScript) - действия операторов

**2. API сервисы:**
- Shop API (Spring Boot) - обработка заказов клиентов
- CRM API (Spring Boot) - управление заказами продавцами
- MES API (C#) - производственные процессы

**3. Базы данных:**
- Shop DB (PostgreSQL) - операции с заказами клиентов
- MES DB (PostgreSQL) - операции с производственными данными

**4. Интеграционные компоненты:**
- Messages Queue (RabbitMQ) - синхронизация между системами
- 3D files storage (S3) - операции с файлами

## Необходимые логи с уровнем INFO

### 1. Бизнес-логика заказов

**Создание и изменение заказов:**
- Создание заказа: время, customer_id, order_id, статус
- Изменение статуса заказа: время, order_id, старый_статус, новый_статус, user_id
- Загрузка 3D файла: время, order_id, file_id, file_size, customer_id
- Расчет стоимости: время, order_id, duration, price, complexity_score

**Производственные процессы:**
- Назначение заказа оператору: время, order_id, operator_id, assigned_by
- Начало производства: время, order_id, operator_id, estimated_duration
- Завершение производства: время, order_id, operator_id, actual_duration, quality_score
- Упаковка заказа: время, order_id, operator_id, packaging_type
- Отправка заказа: время, order_id, tracking_number, shipping_method

### 2. Системные операции

**API запросы:**
- HTTP запросы: время, method, endpoint, status_code, response_time, user_id
- Ошибки API: время, endpoint, error_code, error_message, stack_trace
- Аутентификация: время, user_id, action (login/logout), ip_address

**Интеграции:**
- RabbitMQ сообщения: время, queue_name, message_type, order_id, status
- S3 операции: время, operation, file_id, file_size, duration
- Внешние API вызовы: время, service, endpoint, status_code, duration

**База данных:**
- Медленные запросы: время, query, duration, table_name, rows_affected
- Ошибки БД: время, error_code, error_message, query, table_name
- Транзакции: время, operation, table_name, rows_affected, duration

### 3. Пользовательские действия

**Клиенты (Internet Shop):**
- Регистрация/вход: время, user_id, ip_address, user_agent
- Просмотр товаров: время, user_id, product_id, category
- Работа с 3D редактором: время, user_id, action, duration
- Оформление заказа: время, user_id, order_id, total_amount

**Продавцы (CRM):**
- Просмотр заказов: время, seller_id, order_id, action
- Изменение статуса: время, seller_id, order_id, old_status, new_status
- Работа с клиентами: время, seller_id, customer_id, action

**Операторы (MES):**
- Вход в систему: время, operator_id, ip_address
- Просмотр дашборда: время, operator_id, load_time, filters_applied
- Работа с заказом: время, operator_id, order_id, action, duration

## Другие уровни логирования

### DEBUG уровень
- Детальная информация о выполнении алгоритмов
- Промежуточные значения в расчетах стоимости
- Состояние кэша и буферов
- Детали работы 3D рендеринга

### WARN уровень
- Медленные операции (превышение SLA)
- Нестандартные ситуации в бизнес-логике
- Предупреждения о приближении к лимитам
- Неоптимальные запросы к БД

### ERROR уровень
- Ошибки валидации данных
- Ошибки интеграции между сервисами
- Ошибки доступа к внешним ресурсам
- Критические ошибки в бизнес-логике

### FATAL уровень
- Системные ошибки, требующие немедленного вмешательства
- Ошибки, приводящие к потере данных
- Критические сбои в работе системы

## Мотивация

### Бизнес-обоснование внедрения логирования

**1. Снижение времени диагностики проблем**
- Текущая ситуация: разбор проблем со слов клиентов занимает 2-4 часа
- После внедрения: автоматическая диагностика за 5-15 минут
- Экономия времени поддержки: 80% сокращение времени на диагностику

**2. Предотвращение потери заказов**
- Проблема: заказы "теряются" в системе без видимых причин
- Решение: полное логирование жизненного цикла заказа
- Ожидаемый результат: снижение потерь заказов на 95%

**3. Улучшение качества сервиса**
- Прозрачность процессов для клиентов
- Быстрое выявление узких мест в производстве
- Проактивное решение проблем до жалоб клиентов

**4. Соответствие требованиям аудита**
- Полная трассируемость операций с драгоценностями
- Документирование всех изменений статусов заказов
- Соответствие стандартам качества ювелирной отрасли

### Технические и бизнес-метрики

**Технические метрики:**
1. **Время диагностики инцидентов** - от 2-4 часов до 5-15 минут (улучшение на 90%)
2. **Процент успешной диагностики** - с 60% до 95% (улучшение на 35%)
3. **Время восстановления после сбоев** - с 2-6 часов до 15-30 минут (улучшение на 85%)
4. **Количество ложных срабатываний алертов** - снижение на 70%
5. **Производительность системы логирования** - < 1% накладных расходов

**Бизнес-метрики:**
1. **Время до первого ответа клиенту** - с 2-4 часов до 15-30 минут (улучшение на 85%)
2. **Удовлетворенность клиентов** - с 3.2/5 до 4.5/5 (улучшение на 40%)
3. **Количество жалоб клиентов** - снижение на 60%
4. **Операционная эффективность** - улучшение на 35%
5. **Стоимость поддержки** - снижение на 50%

### Приоритизация систем для внедрения логирования

**Первая очередь (критически важно):**
1. **MES API** - производственные процессы, потеря заказов здесь критична
2. **Messages Queue** - интеграция между системами, источник большинства проблем
3. **Shop API** - точка входа заказов, проблемы здесь блокируют весь процесс

**Вторая очередь (важно):**
4. **CRM API** - управление заказами продавцами
5. **Базы данных** - источник данных для диагностики
6. **3D files storage** - операции с файлами клиентов

**Третья очередь (желательно):**
7. **Frontend приложения** - пользовательские действия
8. **Внешние интеграции** - API пользователи

## Предлагаемое решение

### Архитектура системы логирования

**Технологический стек:**
- **ELK Stack** - Elasticsearch, Logstash, Kibana (основная платформа)
- **Fluentd** - сбор логов с контейнеров и приложений
- **Redis** - буферизация логов для высокой производительности
- **Grafana** - дашборды и алерты (интеграция с мониторингом)
- **Jaeger** - корреляция логов с трейсами

**Компоненты системы логирования:**

1. **Log Collectors** - сбор логов с всех источников
2. **Log Aggregator** - централизованная обработка и обогащение
3. **Log Storage** - Elasticsearch кластер для хранения
4. **Log Analysis** - Kibana для поиска и анализа
5. **Alert Engine** - система алертинга на основе логов
6. **Log Retention** - политики хранения и архивирования

### Инструментирование приложений

**1. Spring Boot приложения (Shop API, CRM API)**
```java
// Структурированное логирование с контекстом
@Slf4j
public class OrderService {
    
    @NewSpan("create-order")
    public Order createOrder(OrderRequest request) {
        MDC.put("orderId", request.getOrderId());
        MDC.put("customerId", request.getCustomerId());
        
        log.info("Order creation started: orderId={}, customerId={}, amount={}", 
                request.getOrderId(), request.getCustomerId(), request.getAmount());
        
        try {
            Order order = processOrder(request);
            log.info("Order created successfully: orderId={}, status={}", 
                    order.getId(), order.getStatus());
            return order;
        } catch (Exception e) {
            log.error("Order creation failed: orderId={}, error={}", 
                     request.getOrderId(), e.getMessage(), e);
            throw e;
        } finally {
            MDC.clear();
        }
    }
}
```

**2. C# MES приложение**
```csharp
// Интеграция с Serilog для структурированного логирования
public class OrderService
{
    private readonly ILogger<OrderService> _logger;
    
    public async Task AssignOrderToOperator(string orderId, string operatorId)
    {
        using var activity = _logger.BeginScope(new Dictionary<string, object>
        {
            ["OrderId"] = orderId,
            ["OperatorId"] = operatorId
        });
        
        _logger.LogInformation("Assigning order to operator: OrderId={OrderId}, OperatorId={OperatorId}", 
                              orderId, operatorId);
        
        try
        {
            await ProcessAssignment(orderId, operatorId);
            _logger.LogInformation("Order assigned successfully: OrderId={OrderId}, OperatorId={OperatorId}", 
                                  orderId, operatorId);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to assign order: OrderId={OrderId}, OperatorId={OperatorId}", 
                           orderId, operatorId);
            throw;
        }
    }
}
```

**3. Frontend приложения (Vue.js, React)**
```javascript
// Логирование пользовательских действий
import { createLogger } from 'vue-logger';

const logger = createLogger({
  level: 'info',
  format: (level, message, context) => {
    return {
      timestamp: new Date().toISOString(),
      level,
      message,
      userId: context.userId,
      sessionId: context.sessionId,
      action: context.action,
      ...context
    };
  }
});

// Использование в компонентах
export default {
  methods: {
    createOrder(orderData) {
      logger.info('Order creation started', {
        action: 'create_order',
        orderData: orderData,
        userId: this.$store.state.user.id
      });
    }
  }
}
```

### Интеграция с существующей системой

**1. Интеграция с мониторингом**
- Корреляция логов с метриками Prometheus
- Алерты на основе логов в Grafana
- Дашборды с лог-данными

**2. Интеграция с трейсингом**
- Связь логов с трейсами через Trace ID
- Централизованный поиск по трейсам и логам
- Автоматическое добавление Trace ID в логи

**3. Интеграция с бизнес-процессами**
- Уведомления о критических событиях
- Автоматическое создание тикетов при проблемах
- Интеграция с CRM для уведомления клиентов

## Политика безопасности

### Обработка чувствительных данных

**1. Маскирование персональных данных**
- Автоматическое маскирование email, телефонов, адресов
- Маскирование номеров карт и платежной информации
- Маскирование персональных данных в 3D файлах

**2. Контроль доступа к логам**
- Ролевая модель доступа:
  - **Support** - доступ к логам для решения проблем
  - **Developer** - доступ к логам своих сервисов
  - **DevOps** - полный доступ к системе логирования
  - **Manager** - доступ к агрегированным отчетам
  - **Auditor** - доступ только к аудит-логам

**3. Шифрование и безопасность**
- TLS 1.3 для передачи логов
- Шифрование данных в покое (AES-256)
- Аудит доступа к логам
- Ротация ключей шифрования

### Соответствие требованиям

**1. GDPR compliance**
- Возможность удаления персональных данных
- Уведомление о сборе данных
- Право на доступ к данным

**2. Локальное хранение**
- Все логи хранятся в России
- Соответствие требованиям 152-ФЗ
- Отсутствие передачи данных за границу

## Политика хранения

### Структура индексов

**1. Индексы по системам**
- `shop-logs-*` - логи Shop API и Internet Shop
- `crm-logs-*` - логи CRM API и CRM
- `mes-logs-*` - логи MES API и MES
- `integration-logs-*` - логи RabbitMQ и внешних интеграций
- `infrastructure-logs-*` - логи инфраструктуры

**2. Индексы по типам логов**
- `business-logs-*` - бизнес-события
- `error-logs-*` - ошибки и исключения
- `audit-logs-*` - аудит-события
- `performance-logs-*` - метрики производительности

### Время хранения

**1. Детальные логи**
- Production: 30 дней
- Staging: 7 дней
- Development: 3 дня

**2. Агрегированные логи**
- Ежедневные агрегаты: 1 год
- Еженедельные агрегаты: 3 года
- Ежемесячные агрегаты: 7 лет

**3. Аудит-логи**
- Полное хранение: 7 лет
- Архивное хранение: 15 лет

### Размеры индексов

**1. Ожидаемые объемы**
- Детальные логи: ~50 GB/день
- Агрегированные логи: ~5 GB/день
- Аудит-логи: ~2 GB/день
- Общий объем: ~57 GB/день

**2. Планирование ресурсов**
- Elasticsearch кластер: 3 узла по 64 GB RAM
- Общий объем хранилища: 10 TB
- Backup хранилище: 20 TB

## Система анализа логов

### Алертинг

**1. Критические алерты**
- Ошибки создания заказов: немедленное уведомление
- Потеря заказов в системе: критический алерт
- Ошибки интеграции между сервисами: алерт в течение 5 минут
- Превышение времени обработки заказа: алерт при превышении SLA

**2. Предупреждающие алерты**
- Медленные операции: алерт при превышении порогов
- Высокий процент ошибок: алерт при >5% ошибок
- Необычные паттерны в логах: алерт на аномалии
- Приближение к лимитам ресурсов: алерт при >80% использования

**3. Информационные алерты**
- Ежедневные отчеты по системе
- Еженедельные тренды производительности
- Месячные отчеты по качеству сервиса

### Поиск аномалий

**1. Автоматическое обнаружение аномалий**
- Резкое увеличение количества заказов (возможная DDoS атака)
- Необычные паттерны в пользовательском поведении
- Аномальные времена выполнения операций
- Неожиданные ошибки в системе

**2. Машинное обучение для анализа**
- Обучение на исторических данных
- Автоматическое выявление новых паттернов
- Предсказание потенциальных проблем
- Кластеризация похожих инцидентов

**3. Интеграция с мониторингом**
- Корреляция с метриками производительности
- Анализ причинно-следственных связей
- Автоматическое создание инцидентов
- Эскалация критических проблем

## Сравнение технологий для работы с логами

| Критерий | ELK Stack | OpenSearch | Splunk | Grafana Loki |
|----------|-----------|------------|--------|--------------|
| **Лицензия** | Elastic License | Apache License 2.0 | Проприетарная | Apache License 2.0 |
| **Стоимость** | Бесплатно (ограниченно) | Бесплатно | $150/GB/год | Бесплатно |
| **Производительность** | Высокая | Высокая | Очень высокая | Средняя |
| **Масштабируемость** | Отличная | Отличная | Отличная | Хорошая |
| **Простота настройки** | Сложная | Средняя | Простая | Простая |
| **Интеграция с экосистемой** | Отличная | Хорошая | Отличная | Хорошая |
| **Поддержка** | Сообщество | Сообщество | Коммерческая | Сообщество |
| **Безопасность** | Хорошая | Хорошая | Отличная | Хорошая |
| **Гибкость запросов** | Отличная | Отличная | Отличная | Средняя |
| **Визуализация** | Kibana | OpenSearch Dashboards | Splunk UI | Grafana |

### Обоснование выбора ELK Stack

**Преимущества:**
1. **Бесплатная лицензия** для базового функционала
2. **Мощные возможности поиска** с Elasticsearch
3. **Гибкая визуализация** с Kibana
4. **Широкая экосистема** и сообщество
5. **Хорошая интеграция** с существующими системами
6. **Масштабируемость** для роста системы

**Недостатки:**
1. **Сложность настройки** требует экспертизы
2. **Высокие требования к ресурсам** для больших объемов
3. **Ограничения лицензии** для продвинутых функций
4. **Необходимость мониторинга** самого стека

**Альтернативы для рассмотрения:**
- **OpenSearch** - если нужна полная открытость
- **Splunk** - если есть бюджет и нужна простота
- **Grafana Loki** - если нужна интеграция с Grafana

## Заключение

Внедрение комплексной системы логирования для "Александрита" критически необходимо для решения текущих проблем с диагностикой и предотвращением потери заказов. Предлагаемое решение на базе ELK Stack обеспечит полную наблюдаемость системы, снизит время диагностики проблем на 90% и предотвратит потерю заказов на 95%.

Ключевые преимущества решения:
- Полная трассируемость бизнес-процессов
- Автоматическое выявление проблем
- Соответствие требованиям безопасности
- Масштабируемость для роста бизнеса
- Интеграция с существующими системами

Реализация должна проводиться поэтапно, начиная с критически важных систем (MES API, Messages Queue, Shop API) и постепенно охватывая всю инфраструктуру.
